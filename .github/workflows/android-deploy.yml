# Android: Build and deploy via Fastlane (Firebase App Distribution for staging, Play Store for production)
# - Push to main → Play Store production (or Firebase prod)
# - Push to staging → Firebase App Distribution (staging)
# Runs on ubuntu-latest; uses Java, Android SDK, Fastlane. No EAS.
# Secrets: FIREBASE_ANDROID_APP_ID, FIREBASE_SERVICE_ACCOUNT_JSON; GOOGLE_PLAY_SERVICE_ACCOUNT_JSON (production).

name: Android Deploy (Fastlane)

on:
  push:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build and deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build-and-deploy-android:
    name: Build & Deploy Android (Fastlane)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set profile
        id: set-profile
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            echo "profile=staging" >> $GITHUB_OUTPUT
          else
            echo "profile=staging" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - name: Install JS dependencies
        run: yarn install --frozen-lockfile

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools-version: 34.0.0

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses || true

      - name: Setup Ruby and Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane (Android)
        working-directory: android
        run: bundle install

      - name: Write Firebase service account (staging)
        if: steps.set-profile.outputs.profile == 'staging'
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > android/firebase-service-account.json

      - name: Write Play Store service account (production)
        if: steps.set-profile.outputs.profile == 'production'
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > android/google-play-service-account.json

      - name: Build and deploy Android
        working-directory: android
        env:
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_SERVICE_ACCOUNT_FILE: firebase-service-account.json
          SUPPLY_JSON_KEY: google-play-service-account.json
          GITHUB_SHA: ${{ github.sha }}
        run: |
          PROFILE="${{ steps.set-profile.outputs.profile }}"
          bundle exec fastlane android "$PROFILE"
