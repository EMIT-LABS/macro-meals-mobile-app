# iOS: Build and deploy to TestFlight via Fastlane (staging or production)
# - Push to main → TestFlight production app
# - Push to staging → TestFlight staging app
# Runs on macos-latest; uses Xcode + Fastlane. No EAS.
# Secrets: APPLE_TEAM_ID, APPLE_APP_ID (asc), and either App Store Connect API key or app-specific password.

name: iOS Deploy to TestFlight (Fastlane)

on:
  push:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build and submit'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'

jobs:
  build-and-submit-ios:
    name: Build & Submit iOS (Fastlane)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set profile
        id: set-profile
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            echo "profile=staging" >> $GITHUB_OUTPUT
          else
            echo "profile=staging" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - name: Install JS dependencies
        run: yarn install --frozen-lockfile

      - name: Setup Ruby and Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane (Gemfile at repo root)
        run: bundle install

      - name: Install CocoaPods (iOS)
        working-directory: ios
        run: pod install

      # Write App Store Connect .p8 key to file (multiline secrets work reliably this way)
      - name: Create App Store Connect API key file
        env:
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          KEY_CONTENT="${APPSTORE_PRIVATE_KEY:-$APP_STORE_CONNECT_API_KEY}"
          echo "$KEY_CONTENT" > "$RUNNER_TEMP/appstore_private_key.p8"
          chmod 600 "$RUNNER_TEMP/appstore_private_key.p8"
          echo "key_path=$RUNNER_TEMP/appstore_private_key.p8" >> $GITHUB_ENV

      - name: Build and upload to TestFlight
        working-directory: ios
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_ID: ${{ secrets.APPLE_APP_ID }}
          # App Store Connect API key (from repo secrets APPSTORE_* or legacy APP_STORE_CONNECT_*)
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPSTORE_KEY_ID || secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID || secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ${{ env.key_path }}
        run: |
          PROFILE="${{ steps.set-profile.outputs.profile }}"
          bundle exec fastlane ios "$PROFILE"
